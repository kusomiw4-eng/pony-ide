<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Apollo IDE - Multi-Round Audit</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --bg: #000; --accent: #00ff41; --text: #00ff41; --err: #ff3333; --warn: #ffaa00; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; height: 100vh; display: flex; flex-direction: column; }
        
        header { height: 50px; background: #0a0a0a; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; }
        .logo { font-size: 14px; font-weight: bold; }
        
        #main { flex: 1; display: flex; overflow: hidden; }
        
        /* Â∑¶ÂÅ¥ÔºöÊéÉÊèèÈÄ≤Â∫¶ */
        #progress-panel { width: 280px; background: #0a0a0a; border-right: 1px solid #333; display: flex; flex-direction: column; }
        #round-tabs { display: flex; border-bottom: 1px solid #333; }
        .round-tab { flex: 1; padding: 10px 5px; text-align: center; font-size: 10px; cursor: pointer; border-bottom: 2px solid transparent; }
        .round-tab.active { border-bottom-color: var(--accent); color: #fff; }
        .round-tab.done { color: var(--accent); }
        .round-tab.running { animation: pulse 1s infinite; }
        
        #file-list { flex: 1; overflow-y: auto; padding: 10px; }
        .file-item { padding: 6px 8px; font-size: 10px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; }
        .file-item.pending { opacity: 0.4; }
        .file-item.scanning { background: #111; border-left: 2px solid var(--accent); }
        .file-item.done { opacity: 0.6; }
        .file-item.has-issue { border-left-color: var(--err); }
        .issue-badge { background: var(--err); color: #000; padding: 1px 5px; border-radius: 3px; font-size: 9px; }
        
        /* ‰∏≠ÈñìÔºöÂ†±Âëä */
        #report-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #report-header { padding: 10px 15px; background: #0a0a0a; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        #report-body { flex: 1; overflow-y: auto; padding: 15px; }
        
        .report-section { margin-bottom: 25px; }
        .section-title { font-size: 12px; color: #666; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #333; }
        
        .issue-card { background: #0a0a0a; border: 1px solid #333; padding: 12px; margin-bottom: 10px; border-radius: 4px; }
        .issue-card.critical { border-left: 3px solid var(--err); }
        .issue-card.high { border-left: 3px solid #ff6600; }
        .issue-card.medium { border-left: 3px solid var(--warn); }
        .issue-card.low { border-left: 3px solid #666; }
        
        .issue-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .issue-file { font-size: 11px; color: #888; }
        .issue-type { font-size: 10px; padding: 2px 8px; border-radius: 3px; }
        .type-syntax { background: #331133; color: #ff66ff; }
        .type-logic { background: #331111; color: var(--err); }
        .type-memory { background: #113311; color: #66ff66; }
        .type-security { background: #333311; color: #ffff66; }
        .type-perf { background: #112233; color: #6699ff; }
        
        .issue-desc { font-size: 12px; line-height: 1.5; margin-bottom: 8px; }
        .issue-code { background: #000; padding: 10px; font-size: 11px; overflow-x: auto; border: 1px solid #222; }
        .issue-fix { margin-top: 10px; padding: 10px; background: #0f1a0f; border: 1px solid #1a331a; font-size: 11px; }
        
        /* Âè≥ÂÅ¥ÔºöÁµ±Ë®à */
        #stats-panel { width: 250px; background: #0a0a0a; border-left: 1px solid #333; padding: 15px; }
        .stat-card { background: #111; padding: 12px; margin-bottom: 10px; border: 1px solid #333; }
        .stat-label { font-size: 10px; color: #666; margin-bottom: 5px; }
        .stat-value { font-size: 20px; font-weight: bold; }
        
        .progress-bar { height: 4px; background: #222; margin-top: 8px; }
        .progress-fill { height: 100%; background: var(--accent); transition: width 0.3s; }
        
        /* ÂïüÂãï */
        #boot { position: fixed; inset: 0; background: rgba(0,0,0,0.98); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 999; }
        .boot-title { font-size: 24px; margin-bottom: 10px; }
        .boot-desc { color: #666; margin-bottom: 30px; font-size: 12px; }
        input { background: #111; border: 1px solid #333; color: #fff; padding: 10px; width: 280px; margin: 5px; text-align: center; }
        button { background: var(--accent); color: #000; border: none; padding: 10px 25px; margin-top: 10px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #333; color: #666; cursor: not-allowed; }
        
        #file-input { display: none; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #333; }
    </style>
</head>
<body>

    <div id="boot">
        <div class="boot-title">‚¨° APOLLO MULTI-ROUND AUDIT</div>
        <div class="boot-desc">5-Round Deep Scan ‚Ä¢ Zero False Negatives</div>
        <input type="password" id="apiKey" placeholder="Enter OpenRouter Key">
        <button onclick="enterSystem()">INITIALIZE SYSTEM</button>
    </div>

    <header>
        <div class="logo">APOLLO_AUDIT // 5-ROUND DEEP SCAN</div>
        <div style="display:flex;gap:15px;align-items:center;font-size:11px;">
            <span id="header-status">READY</span>
            <span id="header-round"></span>
            <button id="uploadBtn" onclick="document.getElementById('file-input').click()">LOAD ZIP</button>
            <button id="startBtn" onclick="startAllRounds()" style="display:none">START SCAN</button>
        </div>
    </header>

    <div id="main">
        <div id="progress-panel">
            <div id="round-tabs">
                <div class="round-tab" data-round="1">R1<br>SYNTAX</div>
                <div class="round-tab" data-round="2">R2<br>LOGIC</div>
                <div class="round-tab" data-round="3">R3<br>MEMORY</div>
                <div class="round-tab" data-round="4">R4<br>SECURE</div>
                <div class="round-tab" data-round="5">R5<br>PERF</div>
            </div>
            <div id="file-list">
                <div style="color:#666;text-align:center;padding:20px;font-size:11px;">Load ZIP to begin</div>
            </div>
        </div>
        
        <div id="report-panel">
            <div id="report-header">
                <span id="report-title">SCAN REPORT</span>
                <span id="report-count"></span>
            </div>
            <div id="report-body">
                <div style="color:#666;text-align:center;margin-top:100px;">
                    <div style="font-size:48px;margin-bottom:20px;">‚¨°</div>
                    Multi-Round Audit System<br><br>
                    <span style="font-size:11px;">Round 1: Syntax errors, unused vars, imports</span><br>
                    <span style="font-size:11px;">Round 2: Logic bugs, race conditions</span><br>
                    <span style="font-size:11px;">Round 3: Memory leaks, resource issues</span><br>
                    <span style="font-size:11px;">Round 4: Security vulnerabilities</span><br>
                    <span style="font-size:11px;">Round 5: Performance bottlenecks</span>
                </div>
            </div>
        </div>
        
        <div id="stats-panel">
            <div class="stat-card">
                <div class="stat-label">TOTAL FILES</div>
                <div class="stat-value" id="stat-total">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">OVERALL PROGRESS</div>
                <div class="stat-value" id="stat-progress">0%</div>
                <div class="progress-bar"><div class="progress-fill" id="progress-bar" style="width:0%"></div></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ISSUES FOUND</div>
                <div class="stat-value" id="stat-issues">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">BY SEVERITY</div>
                <div style="font-size:11px;margin-top:10px;">
                    <div style="color:var(--err)">‚óè Critical: <span id="stat-crit">0</span></div>
                    <div style="color:#ff6600">‚óè High: <span id="stat-high">0</span></div>
                    <div style="color:var(--warn)">‚óè Medium: <span id="stat-med">0</span></div>
                    <div style="color:#666">‚óè Low: <span id="stat-low">0</span></div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">CURRENT ROUND</div>
                <div class="stat-value" id="stat-round">-</div>
            </div>
        </div>
    </div>

    <input type="file" id="file-input" accept=".zip">

    <script>
        let key = '';
        let files = {};
        let allIssues = [];
        let currentRound = 0;
        let scanState = { total: 0, done: 0 };
        let abortScan = false;

        // ===== 5 Ëº™ÊéÉÊèèÁöÑ Prompt (ÈáùÂ∞ç‰Ω†ÁöÑ 3D ÈÅäÊà≤ÂÑ™Âåñ) =====
        const ROUND_PROMPTS = {
            1: `Round 1 - SYNTAX & STRUCTURE: Check for syntax errors, missing imports, unused variables, and type mismatches. Ignore style issues. Output structured JSON.`,
            2: `Round 2 - LOGIC & BUGS: Check for off-by-one errors, infinite loops, incorrect conditionals, and race conditions in async functions. Output structured JSON.`,
            3: `Round 3 - MEMORY & 3D RESOURCES: Focus on THREE.js/WebGL memory leaks. Look for un-disposed geometries, textures, materials, and accumulation in arrays/objects. Output structured JSON.`,
            4: `Round 4 - SECURITY: Check for injection risks, unsafe innerHTML usage, and exposed secrets. Output structured JSON.`,
            5: `Round 5 - PERFORMANCE: Identify O(n^2) loops, blocking main thread operations, layout thrashing, and unnecessary re-renders. Output structured JSON.`
        };

        function enterSystem() {
            key = document.getElementById('apiKey').value;
            if (!key) return alert('Key?');
            document.getElementById('boot').style.display = 'none';
        }

        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const zip = new JSZip();
            const content = await zip.loadAsync(file);
            files = {}; allIssues = [];
            
            // üî• ÈÄôË£°Â∞±ÊòØ‰Ω†ÁöÑÁôΩÂêçÂñÆÈÅéÊøæÂô®
            const ALLOWED = ['.js', '.html', '.css', '.ts'];
            
            for (let path in content.files) {
                // ÈÅéÊøæÂûÉÂúæ
                if (!content.files[path].dir && !path.includes('__MACOSX') && !path.includes('.DS_Store') && !path.includes('.git/')) {
                    // Ê™¢Êü•ÂâØÊ™îÂêç
                    if(ALLOWED.some(ext => path.toLowerCase().endsWith(ext))) {
                        const text = await content.files[path].async('string');
                        files[path] = text;
                    }
                }
            }
            
            const total = Object.keys(files).length;
            document.getElementById('stat-total').textContent = total;
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('header-status').textContent = `${total} Valid Files Loaded`;
            renderFileList();
        });

        function renderFileList() {
            const list = document.getElementById('file-list');
            list.innerHTML = '';
            Object.keys(files).forEach(path => {
                const item = document.createElement('div');
                item.className = 'file-item pending';
                item.id = 'file-' + path.replace(/[^a-zA-Z0-9]/g, '-');
                item.innerHTML = `<span style="overflow:hidden;text-overflow:ellipsis">${path}</span><span class="file-status">-</span>`;
                list.appendChild(item);
            });
        }

        async function startAllRounds() {
            document.getElementById('startBtn').disabled = true;
            document.getElementById('uploadBtn').disabled = true;
            abortScan = false;
            
            const filePaths = Object.keys(files);
            
            for (let round = 1; round <= 5; round++) {
                currentRound = round;
                document.getElementById('stat-round').textContent = `Round ${round}`;
                document.getElementById('header-round').textContent = `Running Round ${round}/5...`;
                
                // UI Tab Update
                document.querySelectorAll('.round-tab').forEach(tab => {
                    tab.classList.remove('active', 'running');
                    if (parseInt(tab.dataset.round) === round) tab.classList.add('active', 'running');
                    else if (parseInt(tab.dataset.round) < round) tab.classList.add('done');
                });
                
                scanState = { total: filePaths.length, done: 0 };
                
                // ÁÇ∫‰∫ÜÈÅøÂÖçÁÄèË¶ΩÂô®Âç°Ê≠ªÔºåÊàëÂÄë‰∏ÄÊ¨°Âè™Áôº 3 ÂÄãË´ãÊ±Ç (Concurrency Control)
                await processQueue(filePaths, round, 3);
            }
            
            document.getElementById('header-status').textContent = 'AUDIT COMPLETE';
            document.getElementById('header-round').textContent = 'Done';
            document.getElementById('stat-round').textContent = 'DONE';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('uploadBtn').disabled = false;
            renderFinalReport();
        }

        async function processQueue(paths, round, concurrency) {
            let index = 0;
            const exec = async () => {
                while (index < paths.length) {
                    const path = paths[index++];
                    await scanFileRound(path, round);
                }
            };
            await Promise.all(Array(concurrency).fill(null).map(exec));
        }

        async function scanFileRound(path, round) {
            const fileId = 'file-' + path.replace(/[^a-zA-Z0-9]/g, '-');
            const fileEl = document.getElementById(fileId);
            
            if (fileEl) {
                fileEl.className = 'file-item scanning';
                fileEl.querySelector('.file-status').textContent = `R${round}`;
                fileEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            const code = files[path];
            // ÊØèÊ¨°ÊúÄÂ§öËÆÄ 30k Â≠óÔºåËá™ÂãïÊà™Êñ∑
            const safeCode = code.substring(0, 30000); 
            
            const prompt = `${ROUND_PROMPTS[round]}
            
File: ${path}
Code Snippet:
\`\`\`
${safeCode}
\`\`\`

RETURN ONLY JSON format:
{
  "issues": [
    {
      "severity": "critical|high|medium|low",
      "line": 10,
      "description": "Short description of the issue",
      "code_snippet": "The problematic code",
      "suggestion": "How to fix it"
    }
  ]
}
If no issues, return {"issues": []}`;

            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'liquid/lfm-40b', // ‰ΩøÁî® Liquid Êàñ PonyÔºåÈÄôË£°È†êË®≠ Liquid Âõ†ÁÇ∫ JSON ÊØîËºÉÁ©©
                        messages: [{ role: 'user', content: prompt }]
                    })
                });
                
                const data = await res.json();
                const content = data.choices?.[0]?.message?.content || "";
                
                // ÂòóË©¶Ëß£Êûê JSON
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const parsed = JSON.parse(jsonMatch[0]);
                    if (parsed.issues && parsed.issues.length > 0) {
                        parsed.issues.forEach(i => {
                            allIssues.push({ ...i, file: path, type: ['','syntax','logic','memory','security','perf'][round] });
                        });
                        if(fileEl) fileEl.classList.add('has-issue');
                    }
                }
            } catch (e) { console.log(e); }

            if (fileEl) {
                fileEl.classList.remove('scanning');
                fileEl.classList.add('done');
            }
            
            scanState.done++;
            updateStats();
        }

        function updateStats() {
            const totalSteps = Object.keys(files).length * 5;
            const currentSteps = ((currentRound-1) * Object.keys(files).length) + scanState.done;
            const pct = Math.round((currentSteps/totalSteps)*100);
            
            document.getElementById('stat-progress').textContent = pct + '%';
            document.getElementById('progress-bar').style.width = pct + '%';
            document.getElementById('stat-issues').textContent = allIssues.length;
        }

        function renderFinalReport() {
            const container = document.getElementById('report-body');
            let html = '';
            
            // ÊéíÂ∫è: Critical First
            allIssues.sort((a,b) => {
                const map = { critical: 0, high: 1, medium: 2, low: 3 };
                return map[a.severity] - map[b.severity];
            });

            // Áµ±Ë®à
            document.getElementById('stat-crit').innerText = allIssues.filter(i=>i.severity==='critical').length;
            document.getElementById('stat-high').innerText = allIssues.filter(i=>i.severity==='high').length;
            document.getElementById('stat-med').innerText = allIssues.filter(i=>i.severity==='medium').length;
            document.getElementById('stat-low').innerText = allIssues.filter(i=>i.severity==='low').length;

            allIssues.forEach(issue => {
                html += `
                <div class="issue-card ${issue.severity}">
                    <div class="issue-header">
                        <span class="issue-file">${issue.file} (Line ${issue.line || '?'})</span>
                        <span class="issue-type type-${issue.type}">${issue.type.toUpperCase()}</span>
                    </div>
                    <div class="issue-desc">${issue.description}</div>
                    ${issue.code_snippet ? `<div class="issue-code">${issue.code_snippet.replace(/</g,'&lt;')}</div>` : ''}
                    <div class="issue-fix">üí° <b>FIX:</b> ${issue.suggestion}</div>
                </div>`;
            });

            if(allIssues.length === 0) html = "<div style='text-align:center; padding:50px; color:#00ff41;'>‚ú® PERFECT CODE. NO ISSUES FOUND.</div>";
            container.innerHTML = html;
        }
    </script>
</body>
</html>
