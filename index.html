<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Apollo IDE - Multi-Round Audit</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --bg: #000; --accent: #00ff41; --text: #00ff41; --err: #ff3333; --warn: #ffaa00; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; height: 100vh; display: flex; flex-direction: column; }
        
        header { height: 50px; background: #0a0a0a; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; }
        .logo { font-size: 14px; font-weight: bold; }
        
        #main { flex: 1; display: flex; overflow: hidden; }
        
        /* 左側：掃描進度 */
        #progress-panel { width: 280px; background: #0a0a0a; border-right: 1px solid #333; display: flex; flex-direction: column; }
        #round-tabs { display: flex; border-bottom: 1px solid #333; }
        .round-tab { flex: 1; padding: 10px 5px; text-align: center; font-size: 10px; cursor: pointer; border-bottom: 2px solid transparent; }
        .round-tab.active { border-bottom-color: var(--accent); color: #fff; }
        .round-tab.done { color: var(--accent); }
        .round-tab.running { animation: pulse 1s infinite; }
        
        #file-list { flex: 1; overflow-y: auto; padding: 10px; }
        .file-item { padding: 6px 8px; font-size: 10px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; }
        .file-item.pending { opacity: 0.4; }
        .file-item.scanning { background: #111; border-left: 2px solid var(--accent); }
        .file-item.done { opacity: 0.6; }
        .file-item.has-issue { border-left-color: var(--err); }
        .issue-badge { background: var(--err); color: #000; padding: 1px 5px; border-radius: 3px; font-size: 9px; }
        
        /* 中間：報告 */
        #report-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #report-header { padding: 10px 15px; background: #0a0a0a; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        #report-body { flex: 1; overflow-y: auto; padding: 15px; }
        
        .report-section { margin-bottom: 25px; }
        .section-title { font-size: 12px; color: #666; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #333; }
        
        .issue-card { background: #0a0a0a; border: 1px solid #333; padding: 12px; margin-bottom: 10px; border-radius: 4px; }
        .issue-card.critical { border-left: 3px solid var(--err); }
        .issue-card.high { border-left: 3px solid #ff6600; }
        .issue-card.medium { border-left: 3px solid var(--warn); }
        .issue-card.low { border-left: 3px solid #666; }
        
        .issue-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .issue-file { font-size: 11px; color: #888; }
        .issue-type { font-size: 10px; padding: 2px 8px; border-radius: 3px; }
        .type-syntax { background: #331133; color: #ff66ff; }
        .type-logic { background: #331111; color: var(--err); }
        .type-memory { background: #113311; color: #66ff66; }
        .type-security { background: #333311; color: #ffff66; }
        .type-perf { background: #112233; color: #6699ff; }
        
        .issue-desc { font-size: 12px; line-height: 1.5; margin-bottom: 8px; }
        .issue-code { background: #000; padding: 10px; font-size: 11px; overflow-x: auto; border: 1px solid #222; }
        .issue-fix { margin-top: 10px; padding: 10px; background: #0f1a0f; border: 1px solid #1a331a; font-size: 11px; }
        
        /* 右側：統計 */
        #stats-panel { width: 250px; background: #0a0a0a; border-left: 1px solid #333; padding: 15px; }
        .stat-card { background: #111; padding: 12px; margin-bottom: 10px; border: 1px solid #333; }
        .stat-label { font-size: 10px; color: #666; margin-bottom: 5px; }
        .stat-value { font-size: 20px; font-weight: bold; }
        
        .progress-bar { height: 4px; background: #222; margin-top: 8px; }
        .progress-fill { height: 100%; background: var(--accent); transition: width 0.3s; }
        
        /* 啟動 */
        #boot { position: fixed; inset: 0; background: rgba(0,0,0,0.98); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 999; }
        .boot-title { font-size: 24px; margin-bottom: 10px; }
        .boot-desc { color: #666; margin-bottom: 30px; font-size: 12px; }
        input { background: #111; border: 1px solid #333; color: #fff; padding: 10px; width: 280px; margin: 5px; text-align: center; }
        button { background: var(--accent); color: #000; border: none; padding: 10px 25px; margin-top: 10px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #333; color: #666; cursor: not-allowed; }
        
        #file-input { display: none; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #333; }
    </style>
</head>
<body>

    <div id="boot">
        <div class="boot-title">⬡ APOLLO MULTI-ROUND AUDIT</div>
        <div class="boot-desc">5-Round Deep Scan • Zero False Negatives</div>
        <input type="text" id="endpoint" placeholder="API Endpoint">
        <input type="password" id="key" placeholder="API Key">
        <button onclick="init()">START SYSTEM</button>
    </div>

    <header>
        <div class="logo">APOLLO_AUDIT // 5-ROUND DEEP SCAN</div>
        <div style="display:flex;gap:15px;align-items:center;font-size:11px;">
            <span id="header-status">READY</span>
            <span id="header-round"></span>
            <button id="uploadBtn" onclick="document.getElementById('file-input').click()">LOAD ZIP</button>
            <button id="startBtn" onclick="startAllRounds()" style="display:none">START SCAN</button>
        </div>
    </header>

    <div id="main">
        <div id="progress-panel">
            <div id="round-tabs">
                <div class="round-tab" data-round="1">R1<br>SYNTAX</div>
                <div class="round-tab" data-round="2">R2<br>LOGIC</div>
                <div class="round-tab" data-round="3">R3<br>MEMORY</div>
                <div class="round-tab" data-round="4">R4<br>SECURITY</div>
                <div class="round-tab" data-round="5">R5<br>PERF</div>
            </div>
            <div id="file-list">
                <div style="color:#666;text-align:center;padding:20px;font-size:11px;">Load ZIP to begin</div>
            </div>
        </div>
        
        <div id="report-panel">
            <div id="report-header">
                <span id="report-title">SCAN REPORT</span>
                <span id="report-count"></span>
            </div>
            <div id="report-body">
                <div style="color:#666;text-align:center;margin-top:100px;">
                    <div style="font-size:48px;margin-bottom:20px;">⬡</div>
                    Multi-Round Audit System<br><br>
                    <span style="font-size:11px;">Round 1: Syntax errors, unused vars, imports</span><br>
                    <span style="font-size:11px;">Round 2: Logic bugs, race conditions</span><br>
                    <span style="font-size:11px;">Round 3: Memory leaks, resource issues</span><br>
                    <span style="font-size:11px;">Round 4: Security vulnerabilities</span><br>
                    <span style="font-size:11px;">Round 5: Performance bottlenecks</span>
                </div>
            </div>
        </div>
        
        <div id="stats-panel">
            <div class="stat-card">
                <div class="stat-label">TOTAL FILES</div>
                <div class="stat-value" id="stat-total">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">OVERALL PROGRESS</div>
                <div class="stat-value" id="stat-progress">0%</div>
                <div class="progress-bar"><div class="progress-fill" id="progress-bar" style="width:0%"></div></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ISSUES FOUND</div>
                <div class="stat-value" id="stat-issues">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">BY SEVERITY</div>
                <div style="font-size:11px;margin-top:10px;">
                    <div style="color:var(--err)">● Critical: <span id="stat-crit">0</span></div>
                    <div style="color:#ff6600">● High: <span id="stat-high">0</span></div>
                    <div style="color:var(--warn)">● Medium: <span id="stat-med">0</span></div>
                    <div style="color:#666">● Low: <span id="stat-low">0</span></div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">CURRENT ROUND</div>
                <div class="stat-value" id="stat-round">-</div>
            </div>
        </div>
    </div>

    <input type="file" id="file-input" accept=".zip">

    <script>
        const config = { key: '', endpoint: '' };
        let files = {};
        let allIssues = [];
        let currentRound = 0;
        let scanState = { total: 0, done: 0 };
        let abortScan = false;

        // ===== 5 輪掃描的 Prompt =====
        const ROUND_PROMPTS = {
            1: `Round 1 - SYNTAX & STRUCTURE ANALYSIS
Check for:
- Syntax errors (missing semicolons, brackets, parentheses)
- Unused variables, functions, imports
- Missing imports or undefined references
- Type mismatches
- Invalid function signatures
Output ONLY real issues. Skip style suggestions.`,

            2: `Round 2 - LOGIC ANALYSIS
Check for:
- Off-by-one errors
- Incorrect conditionals (wrong operators, missing cases)
- Race conditions in async code
- Dead code (unreachable statements)
- Incorrect loop logic
- Null/undefined access risks
Output ONLY real issues with specific line references.`,

            3: `Round 3 - MEMORY & RESOURCE ANALYSIS
Check for:
- Memory leaks (unreleased closures, event listeners)
- Unclosed connections, files, streams
- Circular references
- Cache without expiration
- Large object accumulation
- Missing cleanup in useEffect/componentWillUnmount
Output ONLY real issues.`,

            4: `Round 4 - SECURITY ANALYSIS
Check for:
- XSS vulnerabilities (innerHTML, dangerouslySetInnerHTML)
- SQL/NoSQL injection risks
- Hardcoded secrets (API keys, passwords)
- Insecure deserialization
- Missing input validation
- CSRF risks
- eval() and dynamic code execution
Output ONLY real security issues.`,

            5: `Round 5 - PERFORMANCE ANALYSIS
Check for:
- O(n²) or worse algorithms
- Unnecessary re-renders (React)
- Large bundle imports
- Blocking synchronous operations
- Inefficient DOM manipulation
- Memory-heavy operations in loops
- Missing debounce/throttle
Output ONLY real performance issues.`
        };

        function init() {
            config.key = document.getElementById('key').value;
            config.endpoint = document.getElementById('endpoint').value || 'https://api.liquid.ai/v1/chat/completions';
            if (!config.key) return alert('API Key required');
            document.getElementById('boot').style.display = 'none';
        }

        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const zip = new JSZip();
            const content = await zip.loadAsync(file);
            
            files = {};
            allIssues = [];
            
            for (let path in content.files) {
                if (!content.files[path].dir && isValidFile(path) && !path.includes('node_modules')) {
                    try {
                        const text = await content.files[path].async('string');
                        if (text && text.length > 0) {
                            files[path] = text;
                        }
                    } catch(e) {}
                }
            }
            
            const total = Object.keys(files).length;
            document.getElementById('stat-total').textContent = total;
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('header-status').textContent = `${total} files loaded`;
            
            renderFileList();
        });

        function isValidFile(path) {
            const ext = path.split('.').pop().toLowerCase();
            return ['js','ts','jsx','tsx','py','java','go','rs','c','cpp','php','rb','swift','kt'].includes(ext);
        }

        function renderFileList() {
            const list = document.getElementById('file-list');
            list.innerHTML = '';
            
            Object.keys(files).forEach(path => {
                const item = document.createElement('div');
                item.className = 'file-item pending';
                item.id = 'file-' + hashPath(path);
                item.innerHTML = `
                    <span style="overflow:hidden;text-overflow:ellipsis">${path.split('/').pop()}</span>
                    <span class="file-status">-</span>
                `;
                list.appendChild(item);
            });
        }

        function hashPath(path) {
            let hash = 0;
            for (let i = 0; i < path.length; i++) {
                hash = ((hash << 5) - hash) + path.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash);
        }

        // ===== 多輪掃描主控制 =====
        async function startAllRounds() {
            document.getElementById('startBtn').disabled = true;
            document.getElementById('uploadBtn').disabled = true;
            abortScan = false;
            allIssues = [];
            
            const totalRounds = 5;
            const filePaths = Object.keys(files);
            
            for (let round = 1; round <= totalRounds; round++) {
                if (abortScan) break;
                
                currentRound = round;
                document.getElementById('stat-round').textContent = `Round ${round}`;
                document.getElementById('header-round').textContent = `Round ${round}/5`;
                
                // 更新 tab 狀態
                document.querySelectorAll('.round-tab').forEach(tab => {
                    tab.classList.remove('active', 'running');
                    if (parseInt(tab.dataset.round) === round) {
                        tab.classList.add('active', 'running');
                    } else if (parseInt(tab.dataset.round) < round) {
                        tab.classList.add('done');
                    }
                });
                
                // 並行處理這一輪的所有檔案
                scanState = { total: filePaths.length, done: 0 };
                
                const promises = filePaths.map(path => scanFileRound(path, round));
                await Promise.all(promises);
                
                // 標記這輪完成
                document.querySelector(`.round-tab[data-round="${round}"]`).classList.remove('running');
                document.querySelector(`.round-tab[data-round="${round}"]`).classList.add('done');
            }
            
            // 完成
            document.getElementById('header-status').textContent = 'SCAN COMPLETE';
            document.getElementById('header-round').textContent = '';
            document.getElementById('stat-round').textContent = 'DONE';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('uploadBtn').disabled = false;
            
            renderFinalReport();
        }

        async function scanFileRound(path, round) {
            // 限制並發
            while (scanState.done - scanState.total + MAX_CONCURRENT > 0) {
                await sleep(50);
            }
            
            const fileEl = document.getElementById('file-' + hashPath(path));
            if (fileEl) {
                fileEl.classList.remove('pending');
                fileEl.classList.add('scanning');
                fileEl.querySelector('.file-status').textContent = `R${round}`;
            }
            
            const code = files[path];
            const prompt = ROUND_PROMPTS[round];
            
            try {
                const issues = await analyzeCode(path, code, prompt, round);
                
                if (issues.length > 0) {
                    allIssues.push(...issues);
                    if (fileEl) fileEl.classList.add('has-issue');
                }
            } catch (e) {
                console.error(`Error scanning ${path} round ${round}:`, e);
            }
            
            if (fileEl) {
                fileEl.classList.remove('scanning');
                fileEl.classList.add('done');
            }
            
            scanState.done++;
            updateProgress();
        }

        const MAX_CONCURRENT = 5;

        function sleep(ms) {
            return new Promise(r => setTimeout(r, ms));
        }

        function updateProgress() {
            const total = Object.keys(files).length * 5; // 5 rounds
            const done = (currentRound - 1) * Object.keys(files).length + scanState.done;
            const percent = Math.round((done / total) * 100);
            
            document.getElementById('stat-progress').textContent = percent + '%';
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('stat-issues').textContent = allIssues.length;
        }

        async function analyzeCode(path, code, promptBase, round) {
            const types = ['', 'syntax', 'logic', 'memory', 'security', 'perf'];
            
            // 分段處理
            const chunkSize = 60000;
            const chunks = [];
            for (let i = 0; i < code.length; i += chunkSize) {
                chunks.push(code.substring(i, Math.min(i + chunkSize, code.length)));
            }
            
            const allIssues = [];
            
            for (let i = 0; i < chunks.length; i++) {
                const prompt = `${promptBase}

File: ${path}${chunks.length > 1 ? ` (Part ${i+1}/${chunks.length})` : ''}

\`\`\`
${chunks[i]}
\`\`\`

Output format (JSON):
{
  "issues": [
    {
      "severity": "critical|high|medium|low",
      "line": number_or_null,
      "description": "what's wrong",
      "code_snippet": "the problematic code",
      "suggestion": "how to fix"
    }
  ]
}

Only output the JSON. If no issues found, output {"issues":[]}`;

                try {
                    const res = await fetch(config.endpoint, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${config.key}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'liquid/lfm-40b',
                            messages: [{ role: 'user', content: prompt }],
                            max_tokens: 2048
                        })
                    });

                    if (!res.ok) continue;

                    const data = await res.json();
                    const content = data.choices?.[0]?.message?.content || '';
                    
                    // 解析 JSON
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        try {
                            const parsed = JSON.parse(jsonMatch[0]);
                            if (parsed.issues) {
                                parsed.issues.forEach(issue => {
                                    allIssues.push({
                                        ...issue,
                                        file: path,
                                        type: types[round],
                                        round: round
                                    });
                                });
                            }
                        } catch (e) {}
                    }
                } catch (e) {}
            }
            
            return allIssues;
        }

        function renderFinalReport() {
            const reportBody = document.getElementById('report-body');
            
            // 統計
            const critical = allIssues.filter(i => i.severity === 'critical').length;
            const high = allIssues.filter(i => i.severity === 'high').length;
            const medium = allIssues.filter(i => i.severity === 'medium').length;
            const low = allIssues.filter(i => i.severity === 'low').length;
            
            document.getElementById('stat-crit').textContent = critical;
            document.getElementById('stat-high').textContent = high;
            document.getElementById('stat-med').textContent = medium;
            document.getElementById('stat-low').textContent = low;
            document.getElementById('report-count').textContent = `${allIssues.length} issues`;
            
            // 按嚴重程度排序
            const sorted = [...allIssues].sort((a, b) => {
                const order = { critical: 0, high: 1, medium: 2, low: 3 };
                return order[a.severity] - order[b.severity];
            });
            
            // 按類型分組
            const grouped = {
                syntax: sorted.filter(i => i.type === 'syntax'),
                logic: sorted.filter(i => i.type === 'logic'),
                memory: sorted.filter(i => i.type === 'memory'),
                security: sorted.filter(i => i.type === 'security'),
                perf: sorted.filter(i => i.type === 'perf')
            };
            
            let html = '';
            
            const typeNames = {
                syntax: 'SYNTAX ERRORS',
                logic: 'LOGIC ISSUES',
                memory: 'MEMORY ISSUES',
                security: 'SECURITY VULNERABILITIES',
                perf: 'PERFORMANCE ISSUES'
            };
            
            for (let type in grouped) {
                if (grouped[type].length === 0) continue;
                
                html += `<div class="report-section">
                    <div class="section-title">${typeNames[type]} (${grouped[type].length})</div>`;
                
                grouped[type].forEach(issue => {
                    html += `
                    <div class="issue-card ${issue.severity}">
                        <div class="issue-header">
                            <span class="issue-file">${issue.file}${issue.line ? ':' + issue.line : ''}</span>
                            <span class="issue-type type-${issue.type}">${issue.type.toUpperCase()}</span>
                        </div>
                        <div class="issue-desc">${escapeHtml(issue.description)}</div>
                        ${issue.code_snippet ? `<div class="issue-code">${escapeHtml(issue.code_snippet)}</div>` : ''}
                        ${issue.suggestion ? `<div class="issue-fix"><b>Fix:</b> ${escapeHtml(issue.suggestion)}</div>` : ''}
                    </div>`;
                });
                
                html += `</div>`;
            }
            
            if (html === '') {
                html = '<div style="text-align:center;color:var(--accent);padding:50px;">✓ No issues found!</div>';
            }
            
            reportBody.innerHTML = html;
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;');
        }
    </script>
</body>
</html>
