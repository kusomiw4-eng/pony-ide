<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Apollo IDE - Interactive Audit</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --bg: #000; --accent: #00ff41; --text: #00ff41; --err: #ff3333; --warn: #ffaa00; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; height: 100vh; display: flex; flex-direction: column; }
        
        header { height: 45px; background: #0a0a0a; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; }
        .logo { font-size: 14px; font-weight: bold; }
        
        #main { flex: 1; display: flex; overflow: hidden; }
        
        /* Â∑¶ÂÅ¥ÔºöÊ™îÊ°àÂàóË°® */
        #files-panel { width: 220px; background: #0a0a0a; border-right: 1px solid #333; display: flex; flex-direction: column; }
        #files-header { padding: 10px; border-bottom: 1px solid #333; font-size: 11px; color: #666; }
        #files-list { flex: 1; overflow-y: auto; }
        .file-item { padding: 8px 10px; font-size: 11px; border-bottom: 1px solid #222; cursor: pointer; }
        .file-item:hover { background: #111; }
        .file-item.selected { background: #1a1a1a; border-left: 2px solid var(--accent); }
        .file-item.has-issue { color: var(--warn); }
        
        /* ‰∏≠ÈñìÔºö‰∏ªÂçÄÂüü */
        #center-panel { flex: 1; display: flex; flex-direction: column; }
        
        /* ‰∏äÂçäÔºö‰ª£Á¢ºÂçÄ */
        #code-section { height: 45%; display: flex; flex-direction: column; border-bottom: 1px solid #333; }
        #code-header { padding: 8px 12px; background: #0a0a0a; border-bottom: 1px solid #222; font-size: 11px; display: flex; justify-content: space-between; }
        #code-view { flex: 1; overflow: auto; padding: 12px; font-size: 12px; line-height: 1.7; white-space: pre; }
        #code-view .line { display: block; }
        #code-view .line:hover { background: #111; }
        #code-view .line.error { background: #1a0000; border-left: 2px solid var(--err); }
        #code-view .line.warning { background: #1a1a00; border-left: 2px solid var(--warn); }
        
        /* ‰∏ãÂçäÔºöÂïèÈ°åÂàóË°® */
        #issues-section { height: 55%; display: flex; flex-direction: column; }
        #issues-header { padding: 8px 12px; background: #0a0a0a; border-bottom: 1px solid #222; font-size: 11px; display: flex; justify-content: space-between; }
        #issues-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .issue-card { background: #0a0a0a; border: 1px solid #333; padding: 10px; margin-bottom: 8px; cursor: pointer; }
        .issue-card:hover { border-color: var(--accent); }
        .issue-card.critical { border-left: 3px solid var(--err); }
        .issue-card.high { border-left: 3px solid #ff6600; }
        .issue-card.medium { border-left: 3px solid var(--warn); }
        .issue-card.low { border-left: 3px solid #555; }
        .issue-title { font-size: 11px; color: #fff; margin-bottom: 5px; }
        .issue-meta { font-size: 10px; color: #666; }
        .issue-badge { font-size: 9px; padding: 2px 6px; border-radius: 3px; margin-left: 8px; }
        .badge-critical { background: #331111; color: var(--err); }
        .badge-high { background: #332200; color: #ff6600; }
        .badge-medium { background: #332200; color: var(--warn); }
        .badge-low { background: #222; color: #888; }
        
        /* Âè≥ÂÅ¥ÔºöAI Â∞çË©±Ê°Ü */
        #chat-panel { width: 380px; background: #0a0a0a; border-left: 1px solid #333; display: flex; flex-direction: column; }
        #chat-header { padding: 10px 12px; border-bottom: 1px solid #333; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 12px; }
        
        .message { margin-bottom: 15px; }
        .message-user { text-align: right; }
        .message-user .bubble { background: #1a3a1a; display: inline-block; padding: 8px 12px; border-radius: 8px; max-width: 90%; text-align: left; font-size: 12px; }
        .message-ai .bubble { background: #111; padding: 10px 12px; border-radius: 8px; font-size: 12px; line-height: 1.6; }
        .message-ai .bubble pre { background: #000; padding: 8px; margin: 8px 0; overflow-x: auto; font-size: 11px; }
        
        #chat-input-area { padding: 10px; border-top: 1px solid #333; }
        #chat-input { width: 100%; background: #111; border: 1px solid #333; color: #fff; padding: 10px; font-family: monospace; font-size: 12px; resize: none; height: 60px; }
        #chat-input:focus { outline: none; border-color: var(--accent); }
        #chat-send { margin-top: 8px; background: var(--accent); color: #000; border: none; padding: 8px 16px; cursor: pointer; font-weight: bold; font-size: 11px; }
        #chat-send:disabled { background: #333; color: #666; }
        
        .quick-actions { margin-bottom: 10px; }
        .quick-btn { background: #111; border: 1px solid #333; color: #888; padding: 5px 10px; font-size: 10px; cursor: pointer; margin-right: 5px; margin-bottom: 5px; }
        .quick-btn:hover { border-color: var(--accent); color: var(--accent); }
        
        /* ÂïüÂãï */
        #boot { position: fixed; inset: 0; background: rgba(0,0,0,0.98); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 999; }
        .boot-title { font-size: 24px; margin-bottom: 10px; }
        .boot-desc { color: #666; margin-bottom: 30px; font-size: 12px; }
        input[type="text"], input[type="password"] { background: #111; border: 1px solid #333; color: #fff; padding: 10px; width: 280px; margin: 5px; text-align: center; }
        button { background: var(--accent); color: #000; border: none; padding: 10px 25px; margin-top: 10px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #333; color: #666; }
        
        #file-input { display: none; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #333; }
        
        .typing { color: #666; font-style: italic; }
    </style>
</head>
<body>

    <div id="boot">
        <div class="boot-title">‚¨° APOLLO AUDIT</div>
        <div class="boot-desc">Interactive Code Analysis with AI Chat</div>
        <input type="text" id="endpoint" placeholder="API Endpoint">
        <input type="password" id="key" placeholder="API Key">
        <button onclick="init()">START</button>
    </div>

    <header>
        <div class="logo">APOLLO_AUDIT // INTERACTIVE</div>
        <div style="display:flex;gap:15px;align-items:center;font-size:11px;">
            <span id="status">READY</span>
            <button onclick="document.getElementById('file-input').click()">LOAD ZIP</button>
            <button id="scanBtn" onclick="startScan()" style="display:none">SCAN ALL</button>
        </div>
    </header>

    <div id="main">
        <div id="files-panel">
            <div id="files-header">FILES (<span id="file-count">0</span>)</div>
            <div id="files-list"></div>
        </div>
        
        <div id="center-panel">
            <div id="code-section">
                <div id="code-header">
                    <span id="current-file">No file selected</span>
                    <span id="code-info"></span>
                </div>
                <div id="code-view">// Select a file to view code
// Click on issues to jump to line
// Chat with AI on the right panel</div>
            </div>
            
            <div id="issues-section">
                <div id="issues-header">
                    <span>ISSUES (<span id="issue-count">0</span>)</span>
                    <span id="scan-status"></span>
                </div>
                <div id="issues-list">
                    <div style="color:#666;text-align:center;padding:30px;font-size:11px;">Load ZIP and scan to find issues</div>
                </div>
            </div>
        </div>
        
        <div id="chat-panel">
            <div id="chat-header">
                <span>üí¨ CHAT WITH APOLLO</span>
                <span style="font-size:10px;color:#666">Ask anything</span>
            </div>
            <div id="chat-messages">
                <div class="message message-ai">
                    <div class="bubble">
                        üëã Hi! I'm Apollo. Load your code and I'll help you find bugs.<br><br>
                        You can ask me:<br>
                        ‚Ä¢ "Explain this function"<br>
                        ‚Ä¢ "Why is this code wrong?"<br>
                        ‚Ä¢ "How do I fix this?"<br>
                        ‚Ä¢ "Review this file for security issues"
                    </div>
                </div>
            </div>
            <div id="chat-input-area">
                <div class="quick-actions">
                    <button class="quick-btn" onclick="quickAsk('explain')">Explain this</button>
                    <button class="quick-btn" onclick="quickAsk('fix')">How to fix?</button>
                    <button class="quick-btn" onclick="quickAsk('security')">Security?</button>
                    <button class="quick-btn" onclick="quickAsk('optimize')">Optimize</button>
                </div>
                <textarea id="chat-input" placeholder="Ask Apollo about your code..."></textarea>
                <button id="chat-send" onclick="sendMessage()">SEND</button>
            </div>
        </div>
    </div>

    <input type="file" id="file-input" accept=".zip">

    <script>
        const config = { key: '', endpoint: '' };
        let files = {};
        let issues = [];
        let currentFile = null;
        let chatHistory = [];
        let isScanning = false;

        function init() {
            config.key = document.getElementById('key').value;
            config.endpoint = document.getElementById('endpoint').value || 'https://api.liquid.ai/v1/chat/completions';
            if (!config.key) return alert('API Key required');
            document.getElementById('boot').style.display = 'none';
        }

        // ===== Ê™îÊ°àËºâÂÖ• =====
        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const zip = new JSZip();
            const content = await zip.loadAsync(file);
            
            files = {};
            issues = [];
            
            for (let path in content.files) {
                if (!content.files[path].dir && isValidFile(path) && !path.includes('node_modules')) {
                    try {
                        const text = await content.files[path].async('string');
                        if (text) files[path] = text;
                    } catch(e) {}
                }
            }
            
            document.getElementById('file-count').textContent = Object.keys(files).length;
            document.getElementById('scanBtn').style.display = 'block';
            
            renderFileList();
            addChatMessage('ai', `Loaded ${Object.keys(files).length} files. Click "SCAN ALL" to analyze them.`);
        });

        function isValidFile(path) {
            const ext = path.split('.').pop().toLowerCase();
            return ['js','ts','jsx','tsx','py','java','go','rs','c','cpp','php','rb'].includes(ext);
        }

        function renderFileList() {
            const list = document.getElementById('files-list');
            list.innerHTML = '';
            
            Object.keys(files).forEach(path => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.textContent = path.split('/').pop();
                item.title = path;
                item.onclick = () => selectFile(path);
                list.appendChild(item);
            });
        }

        function selectFile(path) {
            currentFile = path;
            
            document.querySelectorAll('.file-item').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
            
            document.getElementById('current-file').textContent = path;
            document.getElementById('code-info').textContent = `${files[path].length} chars`;
            
            renderCode(path, files[path]);
        }

        function renderCode(path, code) {
            const view = document.getElementById('code-view');
            const lines = code.split('\n');
            const fileIssues = issues.filter(i => i.file === path);
            
            let html = '';
            lines.forEach((line, i) => {
                const lineNum = i + 1;
                const lineIssues = fileIssues.filter(issue => issue.line === lineNum);
                let className = 'line';
                
                if (lineIssues.some(i => i.severity === 'critical' || i.severity === 'high')) {
                    className += ' error';
                } else if (lineIssues.length > 0) {
                    className += ' warning';
                }
                
                html += `<span class="${className}" onclick="askAboutLine('${path}', ${lineNum})">${String(lineNum).padStart(4)}| ${escapeHtml(line)}</span>\n`;
            });
            
            view.innerHTML = html;
        }

        // ===== ÊéÉÊèè =====
        async function startScan() {
            if (isScanning) return;
            isScanning = true;
            document.getElementById('scanBtn').disabled = true;
            document.getElementById('scan-status').textContent = 'Scanning...';
            
            addChatMessage('ai', 'üîç Starting scan. This may take a moment...');
            
            const filePaths = Object.keys(files);
            const allIssues = [];
            let done = 0;
            
            // ‰∏¶Ë°åÊéÉÊèè
            const promises = filePaths.map(async path => {
                const fileIssues = await scanFile(path, files[path]);
                allIssues.push(...fileIssues);
                done++;
                document.getElementById('scan-status').textContent = `${done}/${filePaths.length}`;
                return fileIssues;
            });
            
            await Promise.all(promises);
            
            issues = allIssues;
            document.getElementById('issue-count').textContent = issues.length;
            
            renderIssues();
            
            // Ê®ôË®òÊúâÂïèÈ°åÁöÑÊ™îÊ°à
            const problemFiles = new Set(issues.map(i => i.file));
            document.querySelectorAll('.file-item').forEach(item => {
                const path = Object.keys(files).find(p => p.split('/').pop() === item.textContent);
                if (problemFiles.has(path)) {
                    item.classList.add('has-issue');
                }
            });
            
            isScanning = false;
            document.getElementById('scanBtn').disabled = false;
            document.getElementById('scan-status').textContent = 'Done';
            
            const critical = issues.filter(i => i.severity === 'critical').length;
            const high = issues.filter(i => i.severity === 'high').length;
            
            addChatMessage('ai', `‚úÖ Scan complete!\n\nFound ${issues.length} issues:\n‚Ä¢ ${critical} Critical\n‚Ä¢ ${high} High\n‚Ä¢ ${issues.length - critical - high} Medium/Low\n\nClick on any issue to discuss it with me.`);
        }

        async function scanFile(path, code) {
            const prompt = `Analyze this code for bugs, errors, and issues.

File: ${path}

\`\`\`
${code.substring(0, 50000)}
\`\`\`

Output JSON only:
{
  "issues": [
    {
      "severity": "critical|high|medium|low",
      "line": <line number or null>,
      "type": "bug|security|performance|memory|logic",
      "title": "<short title>",
      "description": "<what's wrong>",
      "suggestion": "<how to fix>"
    }
  ]
}`;

            try {
                const res = await fetch(config.endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.key}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'liquid/lfm-40b',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 2048
                    })
                });

                const data = await res.json();
                const content = data.choices?.[0]?.message?.content || '';
                
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const parsed = JSON.parse(jsonMatch[0]);
                    return (parsed.issues || []).map(i => ({ ...i, file: path }));
                }
            } catch (e) {}
            
            return [];
        }

        function renderIssues() {
            const list = document.getElementById('issues-list');
            
            if (issues.length === 0) {
                list.innerHTML = '<div style="color:var(--accent);text-align:center;padding:30px;">‚úì No issues found!</div>';
                return;
            }
            
            const sorted = [...issues].sort((a, b) => {
                const order = { critical: 0, high: 1, medium: 2, low: 3 };
                return order[a.severity] - order[b.severity];
            });
            
            list.innerHTML = sorted.map((issue, i) => `
                <div class="issue-card ${issue.severity}" onclick="discussIssue(${i})">
                    <div class="issue-title">
                        ${escapeHtml(issue.title)}
                        <span class="issue-badge badge-${issue.severity}">${issue.severity.toUpperCase()}</span>
                    </div>
                    <div class="issue-meta">
                        ${issue.file.split('/').pop()}${issue.line ? ':' + issue.line : ''} ‚Ä¢ ${issue.type}
                    </div>
                </div>
            `).join('');
        }

        // ===== Â∞çË©± =====
        function addChatMessage(role, content) {
            const messages = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `message message-${role}`;
            
            const formattedContent = content
                .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre>$2</pre>')
                .replace(/`([^`]+)`/g, '<code style="background:#000;padding:2px 5px;">$1</code>')
                .replace(/\*\*([^*]+)\*\*/g, '<b>$1</b>')
                .replace(/\n/g, '<br>');
            
            div.innerHTML = `<div class="bubble">${formattedContent}</div>`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;
            
            input.value = '';
            addChatMessage('user', message);
            
            document.getElementById('chat-send').disabled = true;
            
            // ÊßãÂª∫‰∏ä‰∏ãÊñá
            let context = '';
            if (currentFile) {
                context = `\n\nCurrent file: ${currentFile}\n\`\`\`\n${files[currentFile].substring(0, 10000)}\n\`\`\``;
            }
            
            const messages = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message message-ai';
            typingDiv.innerHTML = '<div class="bubble typing">Apollo is thinking...</div>';
            messages.appendChild(typingDiv);
            messages.scrollTop = messages.scrollHeight;
            
            try {
                const res = await fetch(config.endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.key}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'liquid/lfm-40b',
                        messages: [
                            { role: 'system', content: 'You are Apollo, a helpful code auditor. Answer questions about code clearly and concisely.' + context },
                            { role: 'user', content: message }
                        ],
                        stream: true
                    })
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let response = '';

                typingDiv.querySelector('.bubble').classList.remove('typing');
                typingDiv.querySelector('.bubble').innerHTML = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6).trim();
                            if (data === '[DONE]') continue;
                            try {
                                const json = JSON.parse(data);
                                const word = json.choices?.[0]?.delta?.content || '';
                                response += word;
                                
                                const formatted = response
                                    .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre>$2</pre>')
                                    .replace(/`([^`]+)`/g, '<code style="background:#000;padding:2px 5px;">$1</code>')
                                    .replace(/\*\*([^*]+)\*\*/g, '<b>$1</b>')
                                    .replace(/\n/g, '<br>');
                                
                                typingDiv.querySelector('.bubble').innerHTML = formatted;
                                messages.scrollTop = messages.scrollHeight;
                            } catch (e) {}
                        }
                    }
                }
            } catch (e) {
                typingDiv.querySelector('.bubble').innerHTML = `<span style="color:var(--err)">Error: ${e.message}</span>`;
            }
            
            document.getElementById('chat-send').disabled = false;
        }

        function quickAsk(type) {
            const prompts = {
                explain: 'Explain what this code does and how it works:',
                fix: 'What are the bugs in this code and how do I fix them?',
                security: 'Are there any security vulnerabilities in this code?',
                optimize: 'How can I optimize this code for better performance?'
            };
            
            document.getElementById('chat-input').value = prompts[type];
            sendMessage();
        }

        function discussIssue(index) {
            const issue = issues[index];
            if (!issue) return;
            
            // Ë∑≥Âà∞Ë©≤Ê™îÊ°à
            if (issue.file !== currentFile) {
                selectFile(issue.file);
            }
            
            // Ë∑≥Âà∞Ë©≤Ë°å
            if (issue.line) {
                const codeView = document.getElementById('code-view');
                const lines = codeView.querySelectorAll('.line');
                if (lines[issue.line - 1]) {
                    lines[issue.line - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            
            // Âú®Â∞çË©±Ê°ÜË®éË´ñ
            document.getElementById('chat-input').value = `Tell me more about this issue:\n"${issue.title}"\n\n${issue.description}`;
            sendMessage();
        }

        function askAboutLine(path, lineNum) {
            const code = files[path].split('\n')[lineNum - 1];
            document.getElementById('chat-input').value = `What's wrong with line ${lineNum}?\n\`\`\`\n${code}\n\`\`\``;
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // Enter ÈçµÁôºÈÄÅ
        document.getElementById('chat-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
